---
title: "CapstoneProject"
author: "Vivek Appadurai"
date: "February 20, 2016"
output:
    html_document:
        keep_md: true
---

## Loading Libraries

```{r, message = FALSE}
library(dplyr)
library(ggplot2)
library(scales)
library(reshape2)
library(knitr)
```

## Reading Data

```{r}
variableInfo <- read.table("Names.txt", 
                           header = T, 
                           sep = "\t", 
                           fill = NA, 
                           quote = "",
                           stringsAsFactors = FALSE)
L0 <- read.table("L0.txt", header = T, sep = "\t", fill = NA, quote = "")
L1 <- read.table("L1.txt", header = F, sep = "\t", fill = NA, quote = "")
L2 <- read.table("L2.txt", header = F, sep = "\t", fill = NA, quote = "")
L3 <- read.table("L3.txt", header = F, sep = "\t", fill = NA, quote = "")
L4 <- read.table("L4.txt", header = F, sep = "\t", fill = NA, quote = "")
ticDataTraining <- read.table("ticdata2000.txt", 
                              header = F, 
                              sep = "\t", 
                              fill = NA, 
                              quote = "", 
                              stringsAsFactors = FALSE)
ticDataTest <- read.table("ticeval2000.txt", 
                          header = F, 
                          sep = "\t", 
                          fill = NA, 
                          quote = "",
                          stringsAsFactors = FALSE)
```

## Data Cleaning

```{r}
colNames <- variableInfo %>% select(Name) %>% unlist()
names(ticDataTraining) <- colNames
names(ticDataTest) <- colNames[1:85]
ticDataTest$CARAVAN <- NA
ticData <- rbind(ticDataTraining, ticDataTest)
ticData <- left_join(ticData, L0, by = c("MOSTYPE"= "Value"))
ticData <- ticData %>% rename(MOSTYPE2 = Label)
names(L2) <- c("MOSHOOFD","MOSHOOFD2")
ticData <- left_join(ticData, L2)

ticData <- ticData %>% mutate(thirdPartyInsuranceLevel = AWAPART * PWAPART)
ticData <- ticData %>% mutate(thirdPartyInsuranceLevelFirm = AWABEDR * PWABEDR)
ticData <- ticData %>% mutate(thirdPartyInsuranceLevelAgriculture = AWALAND * PWALAND)
ticData <- ticData %>% mutate(carPolicyLevel = APERSAUT * PPERSAUT)
ticData <- ticData %>% mutate(vanPolicyLevel = ABESAUT * PBESAUT)
ticData <- ticData %>% mutate(scooterPolicyLevel = AMOTSCO * PMOTSCO)
ticData <- ticData %>% mutate(lorryPolicyLevel = AVRAAUT * PVRAAUT)
ticData <- ticData %>% mutate(trailerPolicyLevel = AAANHANG * PAANHANG)
ticData <- ticData %>% mutate(tractorPolicyLevel = ATRACTOR * PTRACTOR)
ticData <- ticData %>% mutate(agriMachinePolicyLevel = AWERKT * PWERKT)
ticData <- ticData %>% mutate(mopedPolicyLevel = ABROM * PBROM)
ticData <- ticData %>% mutate(lifeInsuranceLevel = ALEVEN * PLEVEN)
ticData <- ticData %>% mutate(pvtAccidentInsuranceLevel = APERSONG * PPERSONG)
ticData <- ticData %>% mutate(famAccidentInsuranceLevel = AGEZONG * PGEZONG)
ticData <- ticData %>% mutate(disabilityInsuranceLevel = AWAOREG * PWAOREG)
ticData <- ticData %>% mutate(fireInsuranceLevel = ABRAND * PBRAND)
ticData <- ticData %>% mutate(surfInsuranceLevel = AZEILPL * PZEILPL)
ticData <- ticData %>% mutate(boatInusaranceLevel = APLEZIER * PPLEZIER)
ticData <- ticData %>% mutate(bikeInsuranceLevel = AFIETS * PFIETS)
ticData <- ticData %>% mutate(propertyInsuranceLevel = AINBOED * PINBOED)
ticData <- ticData %>% mutate(SocSecInsurancelevel = ABYSTAND * PBYSTAND)

ticDataDerived <- ticData[,c(1:43,86:109)]

ticDataDerived <- ticDataDerived %>% 
    filter(!is.na(CARAVAN)) %>%
    melt(id.vars = c("MOSTYPE", "MOSTYPE2", "MOSHOOFD", "MOSHOOFD2", "CARAVAN"))

ticDataDerived <- ticDataDerived %>% 
    group_by(variable) %>% 
    mutate(num.Caravan.Buyers = sum(CARAVAN))

glimpse(ticDataDerived)

summary(ticDataDerived$num.Caravan.Buyers)

knit_exit()
```

## Exploratory Data Analysis

### Customer Subtype

```{r, fig.height = 10, fig.width = 8}

table(ticData %>% filter(!is.na(CARAVAN)) %>% select(MOSTYPE2))

ggplot(ticData %>% filter(!is.na(CARAVAN)), aes(x = MOSTYPE2, fill = CARAVAN)) + 
    geom_bar(stat = "count") +
    xlab("Customer SubType") +
    ylab("Count") +
    theme_bw() + 
    coord_flip()

ggplot(ticData %>% filter(!is.na(CARAVAN)), aes(x = MOSTYPE2, fill = CARAVAN)) + 
    geom_bar(position = "fill") +
    xlab("Customer SubType") +
    ylab("Proportion") +
    theme_bw() + 
    coord_flip() +
    scale_y_continuous(labels = percent)
```

### Customer Maintype

```{r, fig.height = 4, fig.width = 8}
ggplot(ticData %>% filter(!is.na(CARAVAN)), aes(x = MOSHOOFD2, fill = CARAVAN)) + 
    geom_bar(stat = "count") +
    xlab("Customer MainType") +
    ylab("Count") +
    theme_bw() + 
    coord_flip()

ggplot(ticData %>% filter(!is.na(CARAVAN)), aes(x = MOSHOOFD2, fill = CARAVAN)) + 
    geom_bar(position = "fill") +
    xlab("Customer MainType") +
    ylab("Proportion") +
    theme_bw() + 
    coord_flip() +
    scale_y_continuous(labels = percent)
```

### Investigating Numeric Variables

```{r, fig.width = 8, fig.height = 10, warning = FALSE}

label_names <- list('MAANTHUI' = "Number of Houses",
                    'MGEMOMV'  = "Avg. Household Size",
                    'MGEMLEEF' = "Average Age",
                    'MGODRK'   = "Roman Catholics",
                    'MGODPR'   = "Protestants",
                    'MGODOV'   = "Other Religion",
                    'MGODGE'   = "No Religion",
                    'MRELGE'   = "Married",
                    'MRELSA'   = "Living Together",
                    'MRELOV'   = "Other Relation",
                    'MFALLEEN' = "Singles",
                    'MFGEKIND' = "No. Child Households",
                    'MFWEKIND' = "Child Households",
                    'MOPLHOOG' = "High Level Ed",
                    'MOPLMIDD' = "Med. Level Ed",
                    'MOPLLAAG' = "Low. Level Ed",
                    'MBERHOOG' = "High Status",
                    'MBERZELF' = "Entrepreneur",
                    'MBERBOER' = "Farmer",
                    'MBERMIDD' = "Mid. Management",
                    'MBERARBG' = "Skilled Labor",
                    'MBERARBO' = "Unskilled Labor",
                    'MSKA'     = "Social Class A",
                    'MSKB1'    = "Social Class B1",
                    'MSKB2'    = "Social Class B2",
                    'MSKC'     = "Social Class C",
                    'MSKD'     = "Social Class D",
                    'MHHUUR'   = "Rented House",
                    'MHKOOP'   = "Home Owners",
                    'MAUT1'    = "1 CAR",
                    'MAUT2'    = "2 CAR",
                    'MAUT0'    = "No CAR",
                    'MZFONDS'  = "Nat. Health Service",
                    'MZPART'   = "Pvt. Health Insurance",
                    'MINKM30'  = "Income < 30k",
                    'MINK3045' = "30k < Income < 40k",
                    'MINK4575' = "45k < Income < 75k",
                    'MINK7512' = "75k < Income < 122k",
                    'MINK123M' = "Income > 123k",
                    'MINKGEM'  = "Avg. Income",
                    'MKOOPKLA' = "Purchasing Power",
                    'thirdPartyInsurancelevel' = "3rd Party Insurance",
                    'thirdPartyInsruancelevelFirm' = "3rd Party Insurance - Firms",
                    'thirdPartyInsuranceLevelAgriculture' = "3rd Party Insurance - Agri",
                    'carPolicyLevel' = "Car Policies",
                    'vanPolicyLevel' = "Van Policies",
                    'scooterPolicyLevel' = "Scooter Policies",
                    'lorryPolicyLevel' = "Lorry Policies",
                    'trailerPolicyLevel' = "Trailer Policies",
                    'tractorPolicyLevel' = "Tractor Policies",
                    'agriMachinePolicyLevel' = "Agricultural Machine Policies",
                    'mopedPolicyLevel' = "Moped Policies",
                    'lifeInsuranceLevel' = "Life Insurance",
                    'pvtAccidentInsuranceLevel' = "Pvt. Accident Insurance",
                    'famAccidentInsuranceLevel' = "Family Accident Insurance",
                    'disabilityInsuranceLevel' = "Disability Insurance",
                    'fireInsuranceLevel' = "Fire Insurance",
                    'surfInsuranceLevel' = "Surfboard Insurance",
                    'boatInsuranceLevel' = "Boat Insurance",
                    'bikeInsuranceLevel' = "Bike Insurance",
                    'propertyInsuranceLevel' = "Property Insurance",
                    'SocSecInsuranceLevel' = "Social Security Insurance")

facet_labeller <- function(variable,value)
                  {
                    return(label_names[value])
                  }

ggplot(ticDataDerived, aes(x = value, y = num.Caravan.Buyers)) +
    geom_point() +
    facet(~ variable) +
    theme_bw()
```